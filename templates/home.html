<!DOCTYPE html>
<html>
<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <title>Home</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/spin.js/2.3.2/spin.min.js"></script>
    <style>
        .floating-alert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10002;
            min-width: 300px;
            max-width: 420px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.22);
            animation: fadeInScale 0.25s ease-out;
        }

        .floating-alert .alert-header {
            background: linear-gradient(135deg, #2563eb 0%, #16a34a 100%);
            color: #ffffff;
            padding: 12px 16px;
            text-align: center;
            font-weight: 700;
        }

        .upload-stack {
            max-width: 760px;
            margin: 0 auto;
        }

        .download-stack {
            max-width: 700px;
            margin: 0 auto 20px auto;
        }

        .download-card {
            border: 1px solid #dbe3f0;
            border-radius: 12px;
            padding: 14px;
            background: #ffffff;
            box-shadow: 0 6px 18px rgba(15, 23, 42, 0.06);
        }

        @keyframes fadeInScale {
            from { opacity: 0; transform: translate(-50%, -46%); }
            to { opacity: 1; transform: translate(-50%, -50%); }
        }

        .loader {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
            width: 50px;
            height: 50px;
        }

        .corner-theme-btn {
            position: fixed;
            top: 16px;
            right: 214px;
            z-index: 10001;
            width: 42px;
            height: 42px;
            border-radius: 50%;
            border: 1px solid #cfd8e3;
            background: #ffffff;
            color: #1f2937;
            font-size: 18px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(15, 23, 42, 0.08);
            cursor: pointer;
        }

        .corner-quick-btn {
            position: fixed;
            top: 16px;
            right: 160px;
            z-index: 10001;
            width: 42px;
            height: 42px;
            border-radius: 50%;
            border: 1px solid #cfd8e3;
            background: #ffffff;
            color: #1f2937;
            font-size: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(15, 23, 42, 0.08);
            text-decoration: none;
        }

        .menu-collapse-btn {
            position: fixed;
            top: 16px;
            left: 14px;
            z-index: 10003;
            width: 42px;
            height: 42px;
            border-radius: 8px;
            border: 1px solid #cfd8e3;
            background: #10b981;
            color: #ffffff;
            font-size: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(15, 23, 42, 0.14);
            cursor: pointer;
        }

        .menu-collapse-btn:hover {
            background: #059669;
        }

        .collapsed-topbar {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 999;
            height: 74px;
            background: rgba(255, 255, 255, 0.9);
            border-bottom: 1px solid #dbe4f0;
            backdrop-filter: blur(4px);
            padding: 0 18px;
            align-items: center;
            justify-content: flex-start;
            gap: 10px;
        }

        .collapsed-topbar img {
            width: 46px;
            height: 46px;
            object-fit: cover;
            border-radius: 8px;
        }

        .collapsed-topbar-brand {
            font-size: 44px;
            line-height: 1;
            font-weight: 700;
            color: #1e3a8a;
            letter-spacing: 0.5px;
            margin-top: -4px;
        }

        .collapsed-userbar {
            display: none;
            position: fixed;
            top: 74px;
            left: 0;
            right: 0;
            z-index: 998;
            height: 74px;
            background: rgba(255, 255, 255, 0.55);
            border-bottom: 1px solid #dbe4f0;
        }

        .corner-logout-btn {
            position: fixed;
            top: 16px;
            right: 14px;
            z-index: 10001;
            border-radius: 20px;
            padding: 8px 14px;
            font-weight: 600;
        }

        .corner-theme-btn:hover,
        .corner-quick-btn:hover {
            background: #f8fafc;
        }

        body.theme-dark {
            background: #0f172a;
            color: #e2e8f0;
        }

        body.theme-dark nav,
        body.theme-dark .bg-body-tertiary {
            background: #111827 !important;
        }

        body.theme-dark .nav-link {
            color: #cbd5e1 !important;
        }

        body.theme-dark .nav-link.active {
            color: #93c5fd !important;
        }

        .menu-side-nav {
            position: fixed;
            left: 0;
            top: 0;
            width: 250px;
            height: 100vh;
            z-index: 1000;
            padding: 16px 14px 14px;
            background: linear-gradient(180deg, #1f3b55 0%, #1b3148 100%);
            border-right: 1px solid rgba(255, 255, 255, 0.08);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .menu-card {
            border: 1px solid rgba(255, 255, 255, 0.12);
            background: rgba(0, 0, 0, 0.08);
            border-radius: 8px;
            padding: 10px;
            width: 100%;
            max-width: 220px;
        }

        .menu-side-nav.bg-body-tertiary {
            background: linear-gradient(180deg, #1f3b55 0%, #1b3148 100%) !important;
        }

        .menu-side-nav .btn-primary {
            border-radius: 6px;
        }

        .menu-side-nav .nav-link {
            color: #dbeafe;
            font-weight: 500;
        }

        .menu-side-nav .nav-link.active {
            background: #2f64d8;
            color: #ffffff;
        }

        .menu-side-nav .nav-link:not(.active):hover {
            background: rgba(255, 255, 255, 0.08);
            color: #ffffff;
        }

        body.menu-hidden .menu-side-nav {
            transform: translateX(-100%);
            transition: transform 0.25s ease;
        }

        .menu-side-nav {
            transition: transform 0.25s ease;
        }

        .content-with-menu {
            margin-left: 270px;
            width: calc(100vw - 270px);
            max-width: none;
            margin-right: 0;
            padding-top: 24px;
            border-top: 4px solid rgba(207, 216, 227, 0.75);
        }

        body.menu-hidden .content-with-menu {
            margin-left: 0;
            width: 100vw;
            padding-left: 18px;
            padding-right: 18px;
            padding-top: 150px;
        }

        body.menu-hidden .collapsed-topbar {
            display: flex;
        }

        body.menu-hidden .collapsed-userbar {
            display: block;
        }

        .sidebar-brand {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 14px;
            margin-top: 14px;
            color: #d1d5db;
            padding: 6px;
            text-align: center;
        }

        .sidebar-brand-logo {
            width: 118px;
            height: 118px;
            border-radius: 999px;
            border: 3px solid rgba(255, 255, 255, 0.35);
            object-fit: cover;
            margin-bottom: 8px;
            background: #ffffff;
        }

        .sidebar-brand-logo-wrap {
            width: 118px;
            height: 118px;
            margin-bottom: 8px;
            position: relative;
        }

        .sidebar-brand-logo-fallback {
            width: 118px;
            height: 118px;
            border-radius: 999px;
            border: 3px solid rgba(255, 255, 255, 0.35);
            background: linear-gradient(135deg, #c7d2fe, #93c5fd);
            color: #1e3a8a;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            font-weight: 800;
            letter-spacing: 0.5px;
            margin: 0;
        }

        .avatar-upload-btn {
            position: absolute;
            right: -4px;
            bottom: -4px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 1px solid #94a3b8;
            background: #fff;
            font-size: 13px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .avatar-upload-btn:hover {
            background: #f8fafc;
        }

        .sidebar-brand-name {
            font-size: 15px;
            font-weight: 700;
            color: #f1f5f9;
            line-height: 1.2;
        }

        @media (max-width: 1200px) {
            .menu-side-nav {
                position: static;
                width: 100%;
                max-width: 340px;
                height: auto;
                margin: 10px auto 0;
                padding: 10px;
                border-right: 0;
            }

            .content-with-menu {
                margin-left: 0;
                width: auto;
                max-width: 100%;
            }
        }
    </style>
  <script>
    // Variable para mantener el estado del bot√≥n de env√≠o
    var isSubmitButtonDisabled = false;

    // Ocultar los inputs de tipo file y mostrar el div con el spinner cuando se hace clic en el bot√≥n "Subir"
    document.addEventListener("DOMContentLoaded", function () {
        var submitBtn = document.getElementById("submitBtn");
        if (!submitBtn) {
            return;
        }

        submitBtn.addEventListener("click", function () {
            if (!isSubmitButtonDisabled) {
                var inputFiles = document.querySelectorAll(".input-file");
                var loaderDiv = document.getElementById("loader");
                var divContainer = document.querySelector(".row.justify-content-md");

                inputFiles.forEach(function (inputFile) {
                    inputFile.classList.add("d-none");
                });

                loaderDiv.style.display = "inline-block";
                divContainer.classList.add("d-none");
                isSubmitButtonDisabled = true; // Desactivar el bot√≥n de env√≠o
            }
        });
    });

    // Mostrar el spinner y deshabilitar el bot√≥n de env√≠o cuando se env√≠a el formulario
    window.addEventListener("load", function () {
        var uploadForm = document.getElementById("fom");
        if (!uploadForm) {
            return;
        }

        uploadForm.addEventListener("submit", function () {
            var target = document.getElementById("loader");
            var spinner = new Spinner().spin(target);

            if (!isSubmitButtonDisabled) {
                document.getElementById("submitBtn").setAttribute("disabled", "true");
                target.style.display = "inline-block";
                isSubmitButtonDisabled = true; // Desactivar el bot√≥n de env√≠o
            }
        });
    });
</script>
<script>
function applyThemeMode() {
    const mode = localStorage.getItem('ensaThemeMode') || 'light';
    document.body.classList.toggle('theme-dark', mode === 'dark');
}

function toggleColorMode() {
    const isDark = document.body.classList.contains('theme-dark');
    const next = isDark ? 'light' : 'dark';
    localStorage.setItem('ensaThemeMode', next);
    applyThemeMode();
}

document.addEventListener('DOMContentLoaded', applyThemeMode);

function applySidebarState() {
    const hidden = localStorage.getItem('ensaSidebarHidden') === '1';
    document.body.classList.toggle('menu-hidden', hidden);
}

function applyMainMenuState() {
    const menu = document.getElementById('mainMenuList');
    const toggle = document.getElementById('mainMenuToggle');
    if (!menu || !toggle) {
        return;
    }

    const expanded = localStorage.getItem('ensaMainMenuExpanded') === '1';
    menu.classList.toggle('d-none', !expanded);
    toggle.setAttribute('aria-expanded', String(expanded));
}

function toggleMainMenuList() {
    const menu = document.getElementById('mainMenuList');
    const toggle = document.getElementById('mainMenuToggle');
    if (!menu || !toggle) {
        return;
    }

    const hidden = menu.classList.toggle('d-none');
    const expanded = !hidden;
    toggle.setAttribute('aria-expanded', String(expanded));
    localStorage.setItem('ensaMainMenuExpanded', expanded ? '1' : '0');
}

function openAvatarUpload() {
    const fileInput = document.getElementById('avatarUploadInput');
    if (fileInput) {
        fileInput.click();
    }
}

function submitAvatarUpload() {
    const fileInput = document.getElementById('avatarUploadInput');
    if (fileInput && fileInput.files && fileInput.files.length > 0) {
        document.getElementById('avatarUploadForm').submit();
    }
}

function toggleMainSidebar() {
    const hidden = !document.body.classList.contains('menu-hidden');
    document.body.classList.toggle('menu-hidden', hidden);
    localStorage.setItem('ensaSidebarHidden', hidden ? '1' : '0');
}

document.addEventListener('DOMContentLoaded', function () {
    applySidebarState();
    applyMainMenuState();
});
</script>
</head>
<body>
    <button type="button" class="menu-collapse-btn" title="Ocultar/mostrar men√∫" aria-label="Ocultar/mostrar men√∫" onclick="toggleMainSidebar()">‚ò∞</button>
    <header class="collapsed-topbar" aria-hidden="true">
        <img src="{{ url_for('static', filename='images/logos.jpeg') }}" alt="ENSA">
        <div class="collapsed-topbar-brand">Ensa</div>
    </header>
    <div class="collapsed-userbar" aria-hidden="true"></div>
    <button type="button" class="corner-theme-btn" title="Modo claro/oscuro" aria-label="Modo claro/oscuro" onclick="toggleColorMode()">üåô</button>
    <a class="corner-quick-btn" href="/correos" title="Ajustes" aria-label="Ajustes">‚öô</a>
    <form id="avatarUploadForm" action="/subir_foto_perfil" method="POST" enctype="multipart/form-data" style="display:none;">
        <input type="hidden" name="next" value="home">
        <input id="avatarUploadInput" type="file" name="profile_image" accept=".png,.jpg,.jpeg,.webp" onchange="submitAvatarUpload()">
    </form>
    <div class="d-flex flex-column min-vh-100">
   <nav class="bg-body-tertiary py-2 menu-side-nav">
    <div class="sidebar-brand">
        <div class="sidebar-brand-logo-wrap">
            {% if has_profile_photo %}
                <img class="sidebar-brand-logo" src="{{ profile_photo_url }}" alt="ENSA">
            {% else %}
                <img class="sidebar-brand-logo" src="{{ url_for('static', filename='images/logos.jpeg') }}" alt="ENSA">
            {% endif %}
            <button type="button" class="avatar-upload-btn" title="Subir foto" aria-label="Subir foto" onclick="openAvatarUpload()">üì∑</button>
        </div>
        <div>ELECTRONORTE S.A.</div>
    </div>
    <div class="menu-card">
        <div class="w-100">
            <button
                id="mainMenuToggle"
                type="button"
                class="btn btn-primary w-100"
                aria-expanded="false"
                aria-controls="mainMenuList"
                onclick="toggleMainMenuList()"
            >Men√∫</button>
            <ul class="nav nav-pills flex-column gap-2 mt-2 d-none" id="mainMenuList" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active text-center" href="/">Home</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-center" href="/basedatos">Base de Datos</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-center" href="/asiento">Asientos</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-center" href="/correos">Correos</a>
                </li>
            </ul>
        </div>
    </div>
   </nav>
    <div class="flex-grow-1 container text-center content-with-menu">
        <h1>Referencia de movimientos bancarios</h1>
        <span class="error">
            {% if error_message %}
            <p>Error: {{ error_message }}</p>
        {% endif %}
        </span>
        {% if mensaje_exito %}
        <div class="floating-alert" id="floatingAlert" data-auto-dismiss="1">
            <div class="alert-header">‚úÖ {{ mensaje_exito }}</div>
        </div>
        {% endif %}
        {% if processing_result %}
        <div class="container text-center pb-4">
            <div class="row download-stack g-3">
                <div class="col-12">
                    <div class="download-card">
                        <form action="/upload" method="POST" class="download-form" data-success-msg="‚úÖ La descarga de movimientos fue exitosamente.">
                            <button type="submit" class="btn btn-success btn-lg w-100">Movimientos</button>
                        </form>
                    </div>
                </div>

                <div class="col-12">
                    <div class="download-card">
                        <form action="/download_recaudos" method="POST" class="download-form" data-success-msg="‚úÖ La descarga de recaudos fue exitosamente.">
                            <button type="submit" class="btn btn-success btn-lg w-100">Recaudos</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-12 d-grid gap-2 col-md-4 mx-auto">
                    <a class="btn btn-secondary" href="/?reset=1">Regresar</a>
                </div>
            </div>

            <div class="row">
                <div class="col">
                    <div class="card">
                        <h1>Estado de cuenta</h1>
                        <label for="movimientos"></label>
                        {% if processing_result.movements.message %}
                        <span>{{ processing_result.movements.message }}</span>
                        <ul>
                            {% for item in processing_result.movements.items %}
                                <li>{{ item["monto"] }}</li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col">
                    <div class="card">
                        <h1>Resumen Transfers</h1>
                        <label for="tranfers"></label>
                        {% if processing_result.transfers.message %}
                        <span class="error">Error {{ processing_result.transfers.message }}</span>
                        <table>
                            <thead>
                                <tr>
                                    <td>Fecha</td>
                                    <td>Ordenante</td>
                                    <td>Monto</td>
                                </tr>
                            </thead>
                            <tbody>
                            {% for item in processing_result.transfers.items %}
                                <tr>
                                    <td>{{ item["fecha"] }}</td>
                                    <td>{{ item["ordenante"] }}</td>
                                    <td>{{ item["monto"] }}</td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col">
                    <div class="card">
                        <h1>Resumen Providers</h1>
                        <label for="providers"></label>
                        {% if processing_result.providers.message %}
                        <span class="error">Error: {{ processing_result.providers.message }}</span>
                        <table>
                            <thead>
                                <tr>
                                    <td>Fecha</td>
                                    <td>Ordenante</td>
                                    <td>Monto</td>
                                </tr>
                            </thead>
                            <tbody>
                            {% for item in processing_result.providers.items %}
                                <tr>
                                    <td>{{ item["fecha"] }}</td>
                                    <td>{{ item["ordenante"] }}</td>
                                    <td>{{ item["monto"] }}</td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col">
                    <div class="card">
                        <h1>Resumen Interbancarios</h1>
                        <label for="interbanks"></label>
                        {% if processing_result.interbanks.message %}
                        <span class="error">Error {{ processing_result.interbanks.message }}</span>
                        <table>
                            <thead>
                                <tr>
                                    <td>Ordenante</td>
                                    <td>Monto</td>
                                    <td>Operacion</td>
                                </tr>
                            </thead>
                            <tbody>
                            {% for item in processing_result.interbanks.items %}
                                <tr>
                                    <td>{{ item["ordenante"] }}</td>
                                    <td>{{ item["monto"] }}</td>
                                    <td>{{ item["operacion"] }}</td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <form method="POST" id="fom" action="/" enctype="multipart/form-data">

            <div class="upload-stack">
            <div class="row justify-content-md-center">
                <div class="col-12">
                    <div>
                        <div class=" box input-group mb-3">
                            <input type="file" class="form-control" name="file" id="mov" accept="application/vnd.ms-excel, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" required>
                            <label class="input-group-text" for="mov">Movimientos</label>
                          </div>
                    </div>
                </div>
            </div>

            <div class="row align-items-start">
                <div class="col-12">
                    <div >
                        <div  class="box input-group mb-3">
                            <input type="file" class="form-control" name="file" id="pro" accept="application/vnd.ms-excel, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet">
                            <label class="input-group-text" for="pro">Proveedores:</label>
                        </div>
                    </div>
                </div>
                <div class="col-12">
                    <div>
                        <div  class="box input-group mb-3">
                            <input type="file" class="form-control" name="file" id="int"  accept="application/vnd.ms-excel, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet">
                            <label class="input-group-text" for="int">Interbancarias:</label>
                        </div>
                    </div>
                </div>
                <div class="col-12">
                    <div>

                        <div  class="box input-group mb-3">
                            <input type="file" class="form-control" name="file" id="tra" accept="application/vnd.ms-excel, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" >
                            <label class="input-group-text" for="tra">Transferencias:</label>
                        </div>
                    </div>
                </div>
              </div>

              <div class="row">
                <div class="col">

                    <div class="d-grid gap-2 col-6 mx-auto">
                        <input   id="submitBtn" class="btn btn-primary" type="submit" value="Procesar">
                      </div>
                </div>
            </div>
            </div>
        </form>
        {% endif %}

        
      </div>

      <div id="loader" class="loader"></div>
      

<footer>
    <div class="text-end">v 0.4.1</div>
    
</footer>
</div>
<script>
function closeFloatingAlert() {
    const floatingAlert = document.getElementById('floatingAlert');
    if (floatingAlert) floatingAlert.style.display = 'none';
}

const floatingAlert = document.getElementById('floatingAlert');
if (floatingAlert && floatingAlert.dataset.autoDismiss === '1') {
    setTimeout(closeFloatingAlert, 2200);
}
</script>
</body>
</html>